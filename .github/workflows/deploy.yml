name: Build and Deploy Hugo site to Azure Blob Storage

on:
  push:
    branches:
      - main  # Changed from main to master to match your repo
  workflow_dispatch:  # Allow manual triggers

permissions:
  contents: read
  id-token: write  # Required for OIDC authentication

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    environment: Production
    env:
      HUGO_VERSION: 0.150.0

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Fetch full history for Hugo's .GitInfo

    - name: Setup Hugo
      uses: peaceiris/actions-hugo@v3
      with:
        hugo-version: ${{ env.HUGO_VERSION }}
        extended: true

    - name: Cache Hugo modules
      uses: actions/cache@v4
      with:
        path: /tmp/hugo_cache
        key: ${{ runner.os }}-hugomod-${{ hashFiles('**/go.sum') }}
        restore-keys: |
          ${{ runner.os }}-hugomod-

    - name: Build the website
      run: |
        hugo --minify --gc --environment production
      env:
        HUGO_CACHEDIR: /tmp/hugo_cache

    - name: Verify build integrity
      run: |
        # Check if critical files exist
        test -f public/index.html || exit 1
        test -f public/sitemap.xml || exit 1
        # Verify no sensitive files are included
        find public -name "*.env" -o -name "*.key" -o -name "*.pem" | grep . && exit 1 || true

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: hugo-public
        path: public/
        retention-days: 7

    - name: Login to Azure
      uses: azure/login@v2
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Upload to Azure Blob Storage
      uses: azure/cli@v2
      with:
        inlineScript: |
          az storage blob upload-batch \
            --account-name ${{ secrets.AZURE_STORAGE_ACCOUNT }} \
            --auth-mode login \
            --destination \$web \
            --source ./public \
            --overwrite \
            --pattern "*" \
            --content-cache-control "public, max-age=3600" \
            --verbose

    - name: Purge Azure CDN
      uses: azure/cli@v2
      with:
        inlineScript: |
          az cdn endpoint purge \
            --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }} \
            --profile-name ${{ secrets.AZURE_CDN_PROFILE_NAME }} \
            --name ${{ secrets.AZURE_CDN_ENDPOINT_NAME }} \
            --content-paths "/*" \
            --verbose
